# Урок 5. SSH (Secure Shell) и SCP

## 1) Что такое SSH
**SSH (Secure Shell)** — сетевой протокол прикладного уровня для **безопасного удалённого доступа** к системе и **туннелирования TCP‑соединений**.  
Он похож по назначению на Telnet/rlogin, но в отличие от них **шифрует весь трафик**, включая пароли. Также через SSH можно безопасно передавать файлы (например, через `scp`). 

### Зачем нужен SSH (ключевые характеристики)
- **Шифрование данных**: защита от перехвата/прослушивания.
- **Аутентификация**: пароль или ключи (public/private).
- **Удалённый доступ**: работа с сервером через CLI.
- **Передача файлов**: с использованием SCP. 

---

## 2) SSH-ключи: публичный и приватный

### 2.1. Идея “пары ключей”
Генерация SSH‑ключа создаёт **пару**:
- **Приватный ключ** — хранится у вас, **секретный**.
- **Публичный ключ** — можно передавать/кладётся на сервер для доступа. 

### 2.2. Генерация ключа (`ssh-keygen`)
Запуск:
```bash
ssh-keygen
```

Типичный сценарий:
- Нажимаете **Enter** для пути по умолчанию:  
  `~/.ssh/id_rsa` (приватный) и `~/.ssh/id_rsa.pub` (публичный)
- Пароль (passphrase) — **по желанию**: можно просто нажать Enter и создать ключ без пароля. 

### 2.3. Где лежат ключи и как посмотреть
Если использовали дефолт:
- `~/.ssh/id_rsa` — приватный
- `~/.ssh/id_rsa.pub` — публичный 

Посмотреть содержимое:
```bash
cat ~/.ssh/id_rsa.pub
cat ~/.ssh/id_rsa
```
⚠️ В Linux **важен регистр и каждый пробел**, поэтому при копировании публичного ключа нельзя “съесть” символ или добавить лишний. 

### 2.4. Как работает аутентификация ключом (простая аналогия)
- Приватный ключ = “физический ключ”
- Публичный ключ на сервере = “замок”
Если они пара (две половинки одной пары) — сервер пускает. 

---

## 3) Добавление публичного ключа на сервер (authorized_keys)

На удалённом сервере публичные ключи добавляются в файл:
```bash
~/.ssh/authorized_keys
```

Редактирование, например через nano:
```bash
nano ~/.ssh/authorized_keys
```

После добавления ключа пользователь сможет входить по SSH с приватным ключом. 

---

## 4) Подключение по SSH

Пример команды:
```bash
ssh -i ~/.ssh/id_rsa ec2-user@linux.itcareerhub.de
```

Разбор:
- `ssh` — запускаем SSH‑соединение
- `-i ~/.ssh/id_rsa` — путь к **приватному** ключу на вашей машине
- `ec2-user@linux.itcareerhub.de` — пользователь и адрес сервера (`user@host`) 

---

## 5) Практика на учебном сервере (из урока)

### 5.1. Задание для закрепления (ключи + вход)
1) Зайти на учебный сервер (после добавления ключа преподавателем).
2) Вывести публичный ключ и отправить в чат.
3) Подключиться по SSH.
4) Сделать скриншот того, что видно после входа.
5) Создать рабочую папку:
```bash
mkdir /opt/ИМЯ_ВАШЕЙ_ГРУППЫ/ВАШЕ_ИМЯ
``` fileciteturn2file0turn2file1

Подсказка по копированию публичного ключа:
- **Windows (PowerShell)**:
  ```powershell
  clip < ~/.ssh/id_ed25519.pub
  ```
- **macOS / Linux**:
  ```bash
  cat ~/.ssh/id_rsa.pub
  ``` fileciteturn2file0

---

## 6) SCP — безопасное копирование файлов

### 6.1. Что такое SCP
**SCP (Secure Copy Protocol)** — протокол для **безопасной передачи файлов**, работает поверх SSH (шифрование + защищённый канал). fileciteturn2file0turn2file1

### 6.2. Общий формат команды
```bash
scp [OPTION] [user@]SRC_HOST:]file1 [user@]DEST_HOST:]file2
```


### 6.3. Пример (скачать файл с сервера в текущую папку)
Обратите внимание на точку `.` — это “текущая директория”.
```bash
scp -i ~/.ssh/id_rsa ec2-user@linux.itcareerhub.de:///opt/ИМЯ_ВАШЕЙ_ГРУППЫ/ВАШЕ_ИМЯ/file .
```


---

## 7) Домашнее задание (кратко)
1) Зайти на учебный сервер.
2) Создать рабочую папку по пути:
   `/opt/ВАША_ГРУППА/ВАШЕ_ИМЯ`
3) Отправить скриншот или список директорий из `/opt`, чтобы было видно созданную директорию. 


---

## Дополнительные материалы

### SSH config файл

Файл `~/.ssh/config` позволяет создавать алиасы:

```bash
Host myserver
    HostName linux.itcareerhub.de
    User ec2-user
    IdentityFile ~/.ssh/id_rsa
    ServerAliveInterval 60
```

Теперь: `ssh myserver`

### SSH туннелирование (Port Forwarding)

#### Local Port Forwarding
```bash
ssh -L 8080:localhost:80 user@remote
# localhost:8080 будет доступен как remote:80
```

#### Remote Port Forwarding
```bash
ssh -R 8080:localhost:3000 user@remote
# Ваш локальный :3000 станет доступен на remote:8080
```

### rsync — мощная альтернатива scp

```bash
rsync -avz /local/ user@remote:/remote/
# -a: archive mode, -v: verbose, -z: сжатие

rsync -avzP /local/ user@remote:/remote/
# -P: показать прогресс + возможность возобновления

rsync -avz --delete /local/ user@remote:/remote/
# --delete: удалить файлы на целевом хосте
```

### Безопасность SSH

```bash
# /etc/ssh/sshd_config
PermitRootLogin no
PasswordAuthentication no  
PubkeyAuthentication yes
Port 2222  # Изменить порт

# После изменений
sudo systemctl restart sshd
```

### Troubleshooting

```bash
ssh -vvv user@host        # Детальный вывод для отладки
ssh-keygen -R hostname    # Удалить ключ хоста из known_hosts
```

### Ресурсы

- [OpenSSH Manual](https://www.openssh.com/manual.html)
- [mosh](https://mosh.org/) — mobile shell (SSH через UDP)
- [tmux](https://github.com/tmux/tmux) — терминальный мультиплексор
