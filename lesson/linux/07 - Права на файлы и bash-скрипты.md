# Урок 7. Права на файлы и bash-скрипты

## 1) Права на файлы в Linux

Посмотреть права:
```bash
ls -la
```

Пример строки прав:
```
-rwxr-xr--
```

### 1.1. Структура прав
- **1-й символ** — тип объекта:
  - `-` обычный файл
  - `d` директория
  - (встречаются также `l` — симлинк и др.)
- **следующие 9 символов** — права, разбитые на 3 группы:
  - **u** (user) — владелец
  - **g** (group) — группа
  - **o** (other) — остальные

Каждая тройка состоит из:
- `r` (read) — чтение
- `w` (write) — запись
- `x` (execute) — выполнение

### 1.2. Что означают r/w/x
- Для **файла**:
  - `r` — читать содержимое
  - `w` — изменять/перезаписывать
  - `x` — запускать как программу/скрипт
- Для **директории**:
  - `r` — смотреть список файлов
  - `w` — создавать/удалять/переименовывать объекты (при наличии ещё и `x`)
  - `x` — “входить” в директорию (traverse), обращаться к файлам внутри по имени

---

## 2) Специальные биты (SUID / SGID / Sticky)

Специальные биты меняют стандартное поведение прав.

### 2.1. SUID (Setuid)
- Если установлен на **исполняемом файле**, он запускается с правами **владельца файла**, а не вызывающего пользователя.
- В правах отображается как **`s` вместо `x`** в части владельца (user).

### 2.2. SGID (Setgid)
- Если установлен на **директории**, новые файлы внутри наследуют **группу директории** (а не группу пользователя).
- В правах отображается как **`s` вместо `x`** в части группы (group).

### 2.3. Sticky bit
- Если установлен на **директории**, то удалять/перемещать файлы в ней может **только владелец файла** (даже если у других есть запись в директорию).
- В правах отображается как **`t` вместо последнего `x`** в части other.

---

## 3) Цвета файлов (визуальная подсказка в терминале)

Обычно (может отличаться в разных системах/темах):
- **Зелёный** — исполняемые файлы
- **Белый** — обычный файл
- **Синий** — каталоги (директории)
- **Светло-синий** — символические ссылки (symlink)
- **Красный** — архивы/сжатые файлы (`.tar`, `.gz`, `.zip`, `.rpm`)

Симлинк (symlink) — это файл, который ссылается на другой файл или директорию.

---

## 4) Управление правами: chmod

`chmod` меняет права доступа файлов/директорий.

### 4.1. Числовая (octal) запись прав
У каждой категории (u/g/o) одна цифра от 0 до 7:

- `0` — нет прав
- `1` — только `x`
- `2` — только `w`
- `3` — `w+x`
- `4` — только `r`
- `5` — `r+x`
- `6` — `r+w`
- `7` — `r+w+x`

Примеры:
```bash
chmod 755 script.sh
# u=rwx, g=rx, o=rx

chmod 644 file.txt
# u=rw, g=r, o=r
```

### 4.2. Буквенная запись (u/g/o/a + +/-/=)
Обозначения:
- `u` — владелец (user)
- `g` — группа (group)
- `o` — остальные (other)
- `a` — все (ugo)
- `+` добавить право
- `-` убрать право
- `=` установить “точно так”

Примеры:
```bash
chmod u+r file.txt          # добавить чтение владельцу
chmod go-w file.txt         # убрать запись у группы и остальных
chmod a+x script.sh         # добавить выполнение всем
chmod +x script.sh          # то же самое (частый вариант)
chmod u=rw,go=r file.txt    # владельцу rw, группе и остальным только r
```

Рекурсивно (для всего внутри директории):
```bash
chmod -R 755 directory
```

---

## 5) Bash-скрипты

### 5.1. Что такое bash-скрипт
Bash-скрипт — набор команд для оболочки Bash (Bourne Again SHell), позволяющий автоматизировать повторяющиеся действия.
Расширение `.sh` обычно используют, но оно **не обязательно**.

### 5.2. Shebang (шебанг)
Первая строка скрипта обычно:
```bash
#!/bin/bash
```
Это говорит системе, каким интерпретатором выполнять скрипт.

### 5.3. Комментарии
Комментарии начинаются с `#` и продолжаются до конца строки:
```bash
# this is a comment
```

### 5.4. Переменные
Переменные задаются **без пробелов**:
```bash
name="Andrew"
echo "Hello $name"
```

---

## 6) Первый скрипт и запуск

### 6.1. Создаём файл `script.sh`
Содержимое:
```bash
#!/bin/bash
echo Hello
date
```

Сделать исполняемым:
```bash
chmod +x script.sh
```

### 6.2. Способы запуска
1) Из текущей директории (когда вы “находитесь рядом” со скриптом):
```bash
./script.sh
```

2) По полному пути:
```bash
/path/to/script.sh
```

3) Через bash:
```bash
bash script.sh
```
Этот способ **выполнит текст**, даже если у файла нет `x` (права на исполнение), но тогда вы вручную указали интерпретатор.

---

## 7) Закрепление (по уроку)

### 7.1. Практика: script.sh + chmod
1) Создать `script.sh`:
```bash
#!/bin/bash
echo Hello
date
```
2) Сохранить файл.
3) Сделать исполняемым:
```bash
chmod +x script.sh
# или
chmod u+x script.sh
```

### 7.2. Практика: комментарий + переменная
Сделать так, чтобы выводилось `Hello <ВашеИмя>`:
```bash
#!/bin/bash
NAME="Viktor"
echo "Hello $NAME"

# today + now
date
```

---

## 8) Домашнее задание (из презентации)

1) Создайте файл `/tmp/file.txt` через `vi` или `nano`.
2) Добавьте в него **3 первые строки** из вывода `df -h`.
3) Дайте права **группе** на **запись и исполнение**.
4) Уберите права для **всех остальных**.
5) Создайте файл `myfirstbashscript.sh` (где угодно).
6) Сделайте его исполняемым.
7) Заведите переменную `USER` и присвойте ей **ваше имя**.
8) Добавьте в скрипт команду/переменную так, чтобы скрипт написал, **из какой директории он работает** (откуда запущен).
9) Допишите в `/tmp/file.txt` содержимое `myfirstbashscript.sh`.
10) После всех операций допишите в `/tmp/file.txt` историю команд.
11) Пришлите `/tmp/file.txt` через:
```bash
export_file /tmp/file.txt
```

Подсказки-скелет (возможная реализация):
```bash
# 2) первые 3 строки df -h
df -h | head -3 >> /tmp/file.txt

# 3-4) права: группе +wx, остальным убрать всё
chmod g+wx,o-rwx /tmp/file.txt

# 9) дописать содержимое скрипта в файл
cat myfirstbashscript.sh >> /tmp/file.txt

# 10) история команд
history >> /tmp/file.txt
```


---

## Дополнительные материалы

### Специальные права

#### SUID (Set User ID)
```bash
chmod u+s file          # Файл выполняется с правами владельца
chmod 4755 file         # То же самое числом
```

**Пример:** `/usr/bin/passwd` имеет SUID, чтобы пользователи могли менять свой пароль.

#### SGID (Set Group ID)
```bash
chmod g+s directory     # Файлы в директории наследуют группу
chmod 2755 directory
```

#### Sticky Bit
```bash
chmod +t /tmp           # Только владелец может удалять свои файлы
chmod 1777 /tmp
```

### ACL (Access Control Lists)

```bash
# Установить ACL
setfacl -m u:username:rwx file     # Дать права пользователю
setfacl -m g:groupname:rx file     # Дать права группе
setfacl -m d:u:username:rwx dir    # ACL по умолчанию для директории

# Просмотр ACL
getfacl file

# Удаление ACL
setfacl -b file                     # Удалить все ACL
setfacl -x u:username file          # Удалить ACL для пользователя
```

### Продвинутые bash-скрипты

#### Условные операторы
```bash
if [ $var -eq 10 ]; then
    echo "Равно 10"
elif [ $var -lt 10 ]; then
    echo "Меньше 10"
else
    echo "Больше 10"
fi

# Проверка файлов
if [ -f file ]; then echo "Файл существует"; fi
if [ -d dir ]; then echo "Директория существует"; fi
if [ -x file ]; then echo "Файл исполняемый"; fi
```

#### Циклы
```bash
# For цикл
for i in {1..5}; do
    echo "Iteration $i"
done

# While цикл
count=0
while [ $count -lt 5 ]; do
    echo $count
    ((count++))
done
```

#### Функции
```bash
function hello() {
    echo "Hello, $1!"
}

hello "World"
```

### Debugging скриптов

```bash
bash -x script.sh       # Показать выполнение каждой команды
bash -n script.sh       # Проверить синтаксис без выполнения

# В скрипте
set -e                  # Выйти при ошибке
set -x                  # Включить отладку
set -u                  # Ошибка при использовании неопределенных переменных
```

### Ресурсы

- [ShellCheck](https://www.shellcheck.net/) — проверка скриптов онлайн
- [Bash Pitfalls](https://mywiki.wooledge.org/BashPitfalls)
- [Advanced Bash-Scripting Guide](https://tldp.org/LDP/abs/html/)
