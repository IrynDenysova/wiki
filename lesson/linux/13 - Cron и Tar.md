# Урок 13. Cron, Crontab + Tar

## План урока
- Что такое tar
- Задание для закрепления
- Что такое cron
- Crontab: расписание cron
- Crontab: создание задания

---

## 1) Что такое tar

**tar** — это утилита командной строки в операционной системе Linux, которая используется для архивации файлов и директорий в один файл.

### История
- "tar" происходит от "Tape ARchive" (ленточный архив)
- Изначально использовалась для архивации данных на магнитных лентах

### Основная функциональность
Tar заключается в:
- Создании архивов
- Добавлении файлов в архив
- Извлечении файлов из архива
- Просмотре содержимого архива

**Важно:** В отличие от других форматов архивов (таких как ZIP), tar не сжимает данные, он просто создает один файл, включающий в себя все выбранные файлы и структуру каталогов.

---

## 2) Основные ключи и функционал tar

| Ключ | Описание |
|------|----------|
| `-c` | Создание нового архива |
| `-x` | Извлечение файлов из архива |
| `-r` | Добавление файлов в существующий архив |
| `-t` | Просмотр содержимого архива |
| `-z` | Сжатие данных с помощью gzip |
| `-v` | Отображение подробного вывода (verbose) |
| `-f` | Определение имени архива |

### Примеры команд

**Создание архива:**
```bash
tar -cf archive.tar file1.txt file2.txt directory1
```
Создаст архив `archive.tar`, который будет содержать файлы `file1.txt`, `file2.txt` и содержимое директории `directory1`.

**Создание архива со сжатием:**
```bash
tar -czf archive.tar.gz directory1
```
Создаст архив `archive.tar.gz` с содержимым директории `directory1` и сжатием данных при помощи gzip.

**Извлечение файлов:**
```bash
tar -xf archive.tar
```

**Просмотр содержимого архива:**
```bash
tar -tf archive.tar
```

**Добавление файлов в архив:**
```bash
tar -rf archive.tar file3.txt directory2
```

**Создание архива с verbose:**
```bash
tar -cvf archive.tar directory
```

---

## 3) Задание для закрепления

### Задание 1
Создать скрипт, который создаст 10 файлов со случайными числами, а затем заархивирует директорию с этими файлами.

```bash
#!/bin/bash

# Создаем временную директорию
mkdir -p /home/tar
temp_dir="/home/tar"

# Создадим файлы
for i in {1..10}; do
    echo "Случайное число: $RANDOM" > "$temp_dir/$i.txt"
done

# Создаем архив из временной директории
tar -czf /tmp/RANDOM.tar.gz -C $temp_dir .

# Удаляем временную директорию
rm -r $temp_dir
```

### Задание 2
Написать скрипт, который:
1. Создает директорию `/home/MyDir`
2. Создает 10 файлов с текущим временем внутри этих файлов
3. Создает архив `mydir.tar.gz` из содержимого этой директории
4. Ожидает 5 секунд
5. Выводит список файлов в архиве в файл `/root/mydir-tar.txt`

```bash
#!/bin/bash
set -e

mkdir -p /home/MyDir

for run in {1..10}
do
    date '+%T' > /home/MyDir/$run.txt
    sleep 0.5
done

tar -cvzf /tmp/mydir.tar.gz /home/MyDir/*
sleep 5
tar -tf /tmp/mydir.tar.gz > /root/mydir-tar.txt
```

**Пояснения:**
- `mkdir -p /home/MyDir` — создает директорию, если она еще не существует
- `for run in {1..10}` — начинает цикл, который будет выполняться 10 раз
- `date '+%T'` — записывает текущее время в формате HH:MM:SS в файл
- `sleep 0.5` — приостанавливает выполнение скрипта на 0.5 секунды
- `tar -cvzf` — создает архив с именем mydir.tar.gz
- `tar -tf` — выводит список файлов в архиве

---

## 4) Что такое cron

**Cron** — это стандартный планировщик задач в Unix и Unix-подобных операционных системах, таких как Linux.

### История
Cron появился в Unix в конце 1970-х годов и с тех пор стал одним из стандартных компонентов многих Unix-подобных систем.

### Компоненты cron

#### Cron tables (Таблицы cron)
Это файлы конфигурации, которые содержат информацию о том, какие задачи должны быть выполнены и когда:
- `/etc/crontab` — содержит системные задачи
- `/var/spool/cron` — файлы cron-таблиц для каждого пользователя

#### Cron jobs (Задачи cron)
Это сами задачи, которые вы хотите автоматизировать. Каждый cron job состоит из:
- Команды или скрипта, который должен быть выполнен
- Расписания, которое определяет, когда задача должна быть выполнена

#### Cron daemon (Демон cron)
Это процесс, который работает на фоне и регулярно проверяет cron-таблицы для запуска задач в соответствии с определенным расписанием.

---

## 5) Crontab: расписание cron

### Структура записи
Каждая запись в файле crontab содержит пять полей, разделенных пробелами или табуляцией:

```
┌───────────── минуты (0 - 59)
│ ┌───────────── часы (0 - 23)
│ │ ┌───────────── день месяца (1 - 31)
│ │ │ ┌───────────── месяц (1 - 12)
│ │ │ │ ┌───────────── день недели (0 - 7) (0 или 7 = воскресенье)
│ │ │ │ │
* * * * * команда для выполнения
```

### Значения и диапазоны

| Символ | Описание | Пример |
|--------|----------|---------|
| `*` | Любое значение | `* * * * *` — каждую минуту |
| `1,2,5` | Список значений | `1,2,5` в поле часов — в 1:00, 2:00 и 5:00 |
| `*/n` | Шаг | `*/15` в поле минут — каждые 15 минут |
| `n-m` | Диапазон значений | `1-5` в поле часов — с 1:00 до 5:59 |

### Примеры расписаний

```bash
0 1 * * *       # В 1:00 каждый день
0 2 * * *       # В 2:00 каждый день
30 8 * * 1-5    # В 8:30 с понедельника по пятницу
*/15 * * * *    # Каждые 15 минут
0 0 1 * *       # В полночь первого числа каждого месяца
```

**Полезный ресурс:** https://crontab.guru/ — для удобного "чтения" crontab. Вносите в него расписание, которое вызывает у вас вопросы, и получаете человекочитаемый вариант.

---

## 6) Crontab: создание задания

### Поддерживаемые ключи команды crontab

| Ключ | Описание |
|------|----------|
| `-e` | Редактирование текущих cron-заданий (открывает файл в текстовом редакторе) |
| `-l` | Вывод текущих cron-заданий |
| `-r` | Удаление текущих cron-заданий |
| `-u user` | Операция от имени другого пользователя |

### Пример создания задания

**Шаг 1: Создадим файлы**

```bash
touch /tmp/script2.sh /tmp/output2.log
echo -e '#!/bin/bash\ndate\necho "it works"' > /tmp/script2.sh
chmod +x /tmp/script2.sh
```

Флаг `-e` в команде echo сообщает командной оболочке интерпретировать последовательности `\n` как символ новой строки.

**Шаг 2: Запускаем редактор crontab**

```bash
crontab -e
```

Откроется редактор (по умолчанию VI).

**Шаг 3: Добавляем задание**

```bash
* * * * * /tmp/script2.sh >> /tmp/output2.log
```

Это задание будет запускать скрипт каждую минуту.

**Шаг 4: Сохраняем и выходим**

В VI: `Esc`, затем `:wq`

**Шаг 5: Проверка наличия задания**

```bash
crontab -l
```

Вывод:
```
* * * * * /tmp/script2.sh >> /tmp/output2.log
```

**Шаг 6: Мониторинг выполнения**

```bash
tail -f /tmp/output2.log
```

При помощи `tail -f` можем отслеживать "хвост" файла и следить за изменением файла. Таким образом мы увидим, что каждую минуту скрипт будет выполняться и в файле будет появляться новая строка.

---

## Резюме

**tar** — мощная утилита для архивации файлов и директорий в Linux:
- Создание архивов: `-c`
- Извлечение: `-x`
- Просмотр: `-t`
- Сжатие: `-z`

**cron** — планировщик задач для автоматизации повторяющихся операций:
- Структура: минуты часы день_месяца месяц день_недели команда
- Управление: `crontab -e` (редактирование), `crontab -l` (просмотр), `crontab -r` (удаление)
- Полезный инструмент для проверки синтаксиса: https://crontab.guru/


---

## Дополнительные материалы

### Примеры реальных cron задач

```bash
# Резервное копирование каждый день в 2:00
0 2 * * * /home/user/backup.sh

# Очистка временных файлов каждый час
0 * * * * find /tmp -mtime +7 -delete

# Перезапуск сервиса каждый понедельник в 3:00
0 3 * * 1 systemctl restart myservice

# Проверка дискового пространства каждые 15 минут
*/15 * * * * df -h | grep -q '9[0-9]%' && echo "Disk almost full" | mail -s "Alert" admin@example.com

# Запуск только по рабочим дням
0 9 * * 1-5 /path/to/script.sh
```

### Логирование cron задач

```bash
# В crontab
*/5 * * * * /path/script.sh >> /var/log/myscript.log 2>&1

# Или в самом скрипте
#!/bin/bash
exec 1>> /var/log/myscript.log
exec 2>&1

echo "[$(date)] Script started"
# ваши команды
echo "[$(date)] Script finished"
```

### Anacron — для систем которые не работают 24/7

```bash
# /etc/anacrontab
1  5  cron.daily   run-parts /etc/cron.daily
7  10 cron.weekly  run-parts /etc/cron.weekly
30 15 cron.monthly run-parts /etc/cron.monthly
```

### Продвинутые возможности tar

#### Исключение файлов
```bash
tar -czf backup.tar.gz --exclude='*.log' --exclude='node_modules' /path/to/dir
```

#### Инкрементное резервное копирование
```bash
# Полное резервное копирование
tar -czf full-backup.tar.gz -g snapshot.file /path

# Инкрементное (только изменения)
tar -czf incremental-backup.tar.gz -g snapshot.file /path
```

#### Извлечение конкретных файлов
```bash
# Список содержимого
tar -tzf archive.tar.gz

# Извлечь конкретный файл
tar -xzf archive.tar.gz path/to/file

# Извлечь файлы с определенным паттерном
tar -xzf archive.tar.gz --wildcards '*.txt'
```

#### Pipe с tar
```bash
# Копирование директорий с сохранением прав
tar -czf - /source | ssh user@host "cd /dest && tar -xzf -"

# Резервное копирование на удаленный сервер
tar -czf - /data | ssh user@backup "cat > backup-$(date +%F).tar.gz"
```

### Комбинация tar и cron

```bash
#!/bin/bash
# backup-script.sh

DATE=$(date +%Y-%m-%d)
BACKUP_DIR="/backups"
SOURCE="/var/www"

# Создать backup
tar -czf $BACKUP_DIR/backup-$DATE.tar.gz $SOURCE

# Удалить старые backup (старше 30 дней)
find $BACKUP_DIR -name "backup-*.tar.gz" -mtime +30 -delete

# Отправить на удаленный сервер
scp $BACKUP_DIR/backup-$DATE.tar.gz user@remote:/backups/

echo "Backup completed: backup-$DATE.tar.gz"
```

```bash
# В crontab
0 2 * * * /path/to/backup-script.sh >> /var/log/backup.log 2>&1
```

### Monitoring cron

```bash
# Просмотр логов cron
sudo tail -f /var/log/syslog | grep CRON
sudo journalctl -u cron -f

# Проверить статус crond
systemctl status cron
```

### Ресурсы

- [Crontab Guru](https://crontab.guru/) — объяснение cron выражений
- [Crontab Generator](https://crontab-generator.org/)
- [GNU Tar Manual](https://www.gnu.org/software/tar/manual/)
