"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
–≤ —Ñ–∞–π–ª—ã —É—Ä–æ–∫–æ–≤ Python.
"""

from pathlib import Path
import re

def extract_sections(content):
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ (## ...) –∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞."""
    sections = []
    for match in re.finditer(r'^##\s+(.+?)$', content, re.MULTILINE):
        title = match.group(1).strip()
        sections.append(title)
    return sections

def create_navigation(sections, lesson_num):
    """–°–æ–∑–¥–∞—ë—Ç —Ä–∞–∑–¥–µ–ª –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤."""
    nav = ["## üìñ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º –∏ —Ñ—É–Ω–∫—Ü–∏—è–º"]
    
    # –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–µ 5-7 –≤–∞–∂–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    important_sections = []
    for section in sections[:10]:  # –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–µ 10 —Ä–∞–∑–¥–µ–ª–æ–≤
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
        if any(skip in section.lower() for skip in ['–º–∏–Ω–∏-—à–ø–∞—Ä–≥–∞–ª–∫–∞', '–¥–æ–º–∞—à–Ω–µ–µ', '–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è', '—Ç–µ—Ä–º–∏–Ω—ã']):
            continue
        important_sections.append(section)
        if len(important_sections) >= 6:
            break
    
    # –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫–∏
    for section in important_sections:
        # –°–æ–∑–¥–∞—ë–º —è–∫–æ—Ä—å (GitHub style)
        anchor = section.lower()
        anchor = re.sub(r'[^\w\s-]', '', anchor)  # —É–¥–∞–ª—è–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã
        anchor = re.sub(r'[\s]+', '-', anchor)    # –ø—Ä–æ–±–µ–ª—ã –≤ –¥–µ—Ñ–∏—Å—ã
        nav.append(f"- [{section}](#{anchor})")
    
    nav.append("")
    nav.append("**[üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã](#-–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)**")
    nav.append("")
    
    return "\n".join(nav)

def create_supplementary_section(lesson_num, lesson_title):
    """–°–æ–∑–¥–∞—ë—Ç —Ä–∞–∑–¥–µ–ª —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π."""
    section = """
---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –í–∞–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

#### 1. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —Ç–µ–º–µ —É—Ä–æ–∫–∞, –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏.

#### 2. –£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ
–î–ª—è –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã.

### üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã

#### –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
```python
# –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ
pass
```

### üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö

**–û—à–∏–±–∫–∞ 1: –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
# –¢–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û
# –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
```

### üìå –ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Python](https://docs.python.org/3/)
- [PEP 8: –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å—Ç–∏–ª—é](https://peps.python.org/pep-0008/)
"""
    return section

def process_file(file_path):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —Ñ–∞–π–ª —É—Ä–æ–∫–∞."""
    print(f"–û–±—Ä–∞–±–æ—Ç–∫–∞: {file_path.name}")
    
    # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    content = file_path.read_text(encoding='utf-8')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ª–∏ —É–∂–µ —Ñ–∞–π–ª
    if 'üìñ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è' in content:
        print(f"  ‚Üí –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return False
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞
    match = re.match(r'(\d+)\s', file_path.stem)
    if not match:
        print(f"  ‚Üí –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä —É—Ä–æ–∫–∞")
        return False
    
    lesson_num = int(match.group(1))
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Å #)
    title_match = re.search(r'^#\s+(.+?)$', content, re.MULTILINE)
    if not title_match:
        print(f"  ‚Üí –ù–µ –Ω–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫")
        return False
    
    title = title_match.group(1)
    title_end = title_match.end()
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã
    sections = extract_sections(content)
    
    # –°–æ–∑–¥–∞—ë–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    navigation = create_navigation(sections, lesson_num)
    
    # –°–æ–∑–¥–∞—ë–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª
    supplementary = create_supplementary_section(lesson_num, title)
    
    # –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    # –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    next_line_match = re.search(r'\n', content[title_end:])
    if next_line_match:
        insert_pos = title_end + next_line_match.end()
    else:
        insert_pos = title_end
    
    # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    new_content = (
        content[:insert_pos] +
        "\n" + navigation + "\n" +
        content[insert_pos:]
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –∫–æ–Ω–µ—Ü
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–µ–∫—Ü–∏—è –≤ –∫–æ–Ω—Ü–µ
    if not 'üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' in new_content:
        new_content += supplementary
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    file_path.write_text(new_content, encoding='utf-8')
    print(f"  ‚úì –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
    return True

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è."""
    base_path = Path(r"c:\Users\cp24\Documents\wiki\lesson\python")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã —É—Ä–æ–∫–æ–≤ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã)
    files = sorted(
        base_path.glob("[0-9]*.md"),
        key=lambda x: int(re.match(r'(\d+)', x.stem).group(1))
    )
    
    print(f"–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(files)}")
    print()
    
    processed = 0
    skipped = 0
    
    for file_path in files:
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (1-5)
        lesson_num = int(re.match(r'(\d+)', file_path.stem).group(1))
        if lesson_num <= 5:
            print(f"–ü—Ä–æ–ø—É—Å–∫ (—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω): {file_path.name}")
            skipped += 1
            continue
        
        if process_file(file_path):
            processed += 1
        else:
            skipped += 1
    
    print()
    print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {processed}")
    print(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped}")
    print("–ì–æ—Ç–æ–≤–æ!")

if __name__ == "__main__":
    main()
