````markdown
# Nextcloud на Debian 13 в Docker + Caddy  
## (на поддомене `s1.example.com`, с учётом конфликтов порта 80 и системного nginx)

> Адаптируй имена/домены под себя:  
> в примерах используется `s1.viktorplus.com` и IP `185.182.184.40`.

---

## 0. Предварительные условия

- Debian 12/13 (у тебя Debian 13 Trixie).
- Уже настроены:
  - пользователь с sudo (например, `viktor`);
  - SSH по ключу;
  - UFW + Fail2Ban.
- Docker и Docker Compose установлены:

```bash
sudo apt update
sudo apt install -y ca-certificates curl gnupg lsb-release

# репозиторий Docker
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg \
  | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
  https://download.docker.com/linux/debian $(lsb_release -cs) stable" \
  | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

sudo systemctl enable docker
sudo systemctl start docker

# разрешить текущему пользователю работать с Docker без sudo
sudo usermod -aG docker viktor
# выйти и зайти в SSH заново
````

Проверка:

```bash
docker --version
docker compose version
```

---

## 1. DNS-настройка поддомена

В панели домена создай A-запись:

|Type|Name|Value (IP)|
|---|---|---|
|A|`s1`|`185.182.184.40`|

Проверить с сервера:

```bash
dig s1.viktorplus.com +short
# должен вернуть 185.182.184.40
```

---

## 2. Фаервол: открыть HTTP/HTTPS

```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload
sudo ufw status
```

---

## 3. Типичная проблема: порт 80 занят системным nginx

### 3.1. Проверка, кто слушает 80-й порт

```bash
sudo ss -ltnp | grep :80 || echo "80/tcp свободен"
```

Примеры вывода:

- если занят **системным nginx**:
    

```text
LISTEN 0 511 0.0.0.0:80 ... users:(("nginx",pid=88580,fd=5), ...)
```

- если занят другим контейнером:
    

```text
LISTEN 0 4096 0.0.0.0:80 ... users:(("docker-proxy",pid=12345,fd=7))
```

---

### 3.2. Отключение системного nginx (универсально)

Если на 80 сидит именно nginx:

```bash
sudo systemctl status nginx    # посмотреть состояние
sudo systemctl stop nginx      # остановить
sudo systemctl disable nginx   # отключить автозапуск
```

Проверить:

```bash
sudo ss -ltnp | grep :80 || echo "80/tcp свободен"
```

> После этого Caddy (или любой другой веб-сервер в Docker) сможет забрать порт 80.

---

### 3.3. Удаление старых тренировочных контейнеров nginx

Если раньше запускался тестовый nginx в Docker:

```bash
docker ps -a --format '{{.Names}}\t{{.Ports}}'
```

Если видишь что-то вроде `nginx-test` или `nginx-compose`:

```bash
# через compose-проект
cd ~/projects/nginx-test  # если проект там
docker compose down       # удаляет контейнеры и сеть проекта

# или обычный run-контейнер
docker stop nginx-test
docker rm nginx-test
```

Проверка:

```bash
docker ps -a
sudo ss -ltnp | grep :80 || echo "80/tcp свободен"
```

---

## 4. Стек Nextcloud + MariaDB + Caddy в Docker

### 4.1. Структура проекта

```bash
mkdir -p ~/projects/nextcloud
cd ~/projects/nextcloud
```

Файлы:

- `docker-compose.yml` — описание сервисов;
    
- `Caddyfile` — конфиг Caddy (reverse proxy + HTTPS);
    
- данные и БД будут храниться в Docker-volume’ах.
    

---

### 4.2. `docker-compose.yml`

```yaml
services:
  caddy:
    image: caddy:2
    container_name: nextcloud-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

  db:
    image: mariadb:11
    container_name: nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --innodb_read_only_compressed=OFF
    environment:
      MYSQL_ROOT_PASSWORD: strongrootpass        # поменять
      MYSQL_PASSWORD: nextcloudpass             # поменять
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
    volumes:
      - db:/var/lib/mysql

  app:
    image: nextcloud
    container_name: nextcloud-app
    restart: unless-stopped
    environment:
      MYSQL_PASSWORD: nextcloudpass             # как выше
      MYSQL_DATABASE: nextcloud
      MYSQL_USER: nextcloud
      MYSQL_HOST: db
    volumes:
      - nextcloud:/var/www/html
    depends_on:
      - db

volumes:
  nextcloud:
  db:
  caddy_data:
  caddy_config:
```

> Важно: **строки `version:` в новых Compose не нужны** — если они есть, убрать, чтобы не было предупреждения.

---

### 4.3. `Caddyfile` (поддомен `s1.viktorplus.com`)

```caddy
s1.viktorplus.com {
    reverse_proxy nextcloud-app:80

    encode gzip

    header {
        Referrer-Policy "no-referrer"
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    }
}
```

Caddy:

- сам получает и обновляет сертификаты Let’s Encrypt;
    
- проксирует все запросы на контейнер Nextcloud (`nextcloud-app:80`).
    

---

## 5. Запуск стека

```bash
cd ~/projects/nextcloud
docker compose up -d
docker compose ps
```

Ожидаемый вывод:

```text
NAME             IMAGE        SERVICE   STATUS          PORTS
nextcloud-caddy  caddy:2      caddy     Up ...          0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp
nextcloud-app    nextcloud    app       Up ...
nextcloud-db     mariadb:11   db        Up ...
```

Проверка портов:

```bash
sudo ss -ltnp | grep ':80\|:443'
```

---

## 6. Первичная настройка Nextcloud

Открыть в браузере:

```text
https://s1.viktorplus.com/
```

Должен появиться установщик Nextcloud (форма **Create administration account**).

Рекомендуемые шаги:

1. Ввести логин (например, `admin`) и сложный пароль.
    
2. Блок **Storage & Database** оставить как есть (автоконфиг через Docker).
    
3. Нажать **Install** и дождаться окончания установки.
    

После установки откроется веб-интерфейс Nextcloud.

---

## 7. Подключение iPhone (автозагрузка фотографий)

1. Установить приложение **Nextcloud** из App Store.
    
2. Ввести адрес сервера: `https://s1.viktorplus.com`.
    
3. Войти под админом (или отдельным пользователем).
    
4. В настройках приложения включить:
    
    - **Automatic upload** фотографий,
        
    - по желанию — только по Wi-Fi, загрузку видео и т.п.
        

Теперь фотографии автоматически попадают на сервер.

---

## 8. Полезные команды для администрирования

### Состояние стека Nextcloud

```bash
cd ~/projects/nextcloud

docker compose ps          # статус контейнеров
docker compose logs -f     # логи всех сервисов
docker compose logs caddy  # только Caddy
docker compose logs app    # только Nextcloud
```

### Перезапуск / остановка

```bash
docker compose restart
docker compose down        # остановить и удалить контейнеры (данные в volumes сохранятся)
docker compose up -d       # поднять снова
```

### Обновление Nextcloud

```bash
cd ~/projects/nextcloud
docker pull nextcloud
docker compose up -d
```

---

## 9. Универсальный чек-лист при проблемах с портом 80 / доступом

1. **DNS:**
    
    ```bash
    dig s1.viktorplus.com +short
    ```
    
    → должен возвращать IP сервера.
    
2. **Фаервол:**
    
    ```bash
    sudo ufw status
    ```
    
    → порты 80 и 443 должны быть `ALLOW`.
    
3. **Кто слушает 80/443:**
    
    ```bash
    sudo ss -ltnp | grep ':80\|:443' || echo "80/443 свободны"
    ```
    
    - если видишь `nginx` → `sudo systemctl stop nginx && sudo systemctl disable nginx`;
        
    - если видишь `docker-proxy` от других контейнеров → остановить/удалить эти контейнеры.
        
4. **Стек Nextcloud запущен:**
    
    ```bash
    cd ~/projects/nextcloud
    docker compose ps
    ```
    
5. **Логи Caddy (проблемы с сертификатом / HTTPS):**
    
    ```bash
    docker compose logs caddy --tail=50
    ```
    

---

## 10. Где лежат данные

- Файлы Nextcloud (в volume, управляется Docker):
    
    ```text
    volume nextcloud_nextcloud  → /var/lib/docker/volumes/nextcloud_nextcloud/_data/
    ```
    
- База MariaDB:
    
    ```text
    volume nextcloud_db → /var/lib/docker/volumes/nextcloud_db/_data/
    ```
    

При необходимости можно вынести их на отдельный диск, примонтировав его вместо volume (bind-mount).

---

```
::contentReference[oaicite:0]{index=0}
```